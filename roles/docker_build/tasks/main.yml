#               SETUP BUILD ENVIRONMENT

- name: Clone uscope docker repo
  git:
    repo: "{{github_url + '/uscope_docker.git'}}"
    dest: docker

- name: enable buildx
  shell: 
  args:
    cmd: docker buildx install
    chdir: docker

- name: create build context
  shell: 
  args:
    cmd: docker buildx create --use
    chdir: docker
#             BUILD PRODUCTION WEB APP ON HOST
- import_tasks: uscope_webapp_builder.yml
  vars:
    app_domain_name: "{{domain_name}}"
    gh_url: '{{github_url}}'

- name: Delete server key to avoid leaks
  file:
    path: docker/client/certs/uscope_0.pem
    state: absent

#                     BUILD CONTAINERS                 

- name: Build driver container
  shell: 
  args:
    cmd: docker buildx build --ssh default --platform linux/arm/v7 -t driver:latest  -o type=docker,dest=- driver > driver.tar
    chdir: docker

- name: Build database container
  shell: 
  args:
    cmd: docker buildx build --ssh default --platform linux/arm/v7 -t database:latest  -o type=docker,dest=- database > database.tar
    chdir: docker

- name: Build server container
  shell: 
  args:
    cmd: docker buildx build --ssh default --platform linux/arm/v7 -t server:latest  -o type=docker,dest=- server > server.tar
    chdir: docker

#               PUSH CONTAINERS TO TARGET

- name: push driver images to target
  command: 
  args:
    cmd:  scp driver.tar {{remote_host}}:/home/root
    chdir: docker

- name: push server images to target
  command: 
  args:
    cmd:  scp server.tar {{remote_host}}:/home/root
    chdir: docker

- name: push database images to target
  command: 
  args:
    cmd:  scp database.tar {{remote_host}}:/home/root
    chdir: docker

- name: push client images to target
  command: 
  args:
    cmd:  scp client.tar {{remote_host}}:/home/root
    chdir: docker

- name: push docker-compose 
  command: 
  args:
    cmd:  scp docker-compose_zed.yml {{remote_host}}:/home/root/docker-compose.yml
    chdir: docker

#               CLEAN UP BUILD DIRECTORY

- name: Clean up docker directory
  file:
    path: docker
    state: absent

- name: Clean up webapp directory
  file:
    path: webapp
    state: absent