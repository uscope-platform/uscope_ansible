- hosts: localhost
  vars:
    docker_source_dir: /home/fils/git/uscope_docker
    remote_host: root@uscope_0.local
  tasks:

  - name: Clone uscope docker repo
    git:
      repo: git@github.com:filssavi/uscope_docker.git
      dest: docker

  - name: enable buildx
    shell: 
    args:
      cmd: docker buildx install
      chdir: docker

  - name: create build context
    shell: 
    args:
      cmd: docker buildx create --use
      chdir: docker
  
  - import_tasks: generate_cert.yml
    vars:
      cert_path: docker/client/certs

  - name: Build driver container
    shell: 
    args:
      cmd: docker buildx build --ssh default --platform linux/arm/v7 -t driver:latest  -o type=docker,dest=- driver > driver.tar
      chdir: docker

  - name: Build server container
    shell: 
    args:
      cmd: docker buildx build --ssh default --platform linux/arm/v7 -t server:latest  -o type=docker,dest=- server > server.tar
      chdir: docker
  
  - name: Build database container
    shell: 
    args:
      cmd: docker buildx build --ssh default --platform linux/arm/v7 -t database:latest  -o type=docker,dest=- database > database.tar
      chdir: docker
  
  - name: Build client container
    shell: 
    args:
      cmd: docker buildx build --ssh default --platform linux/arm/v7 -t client:latest  -o type=docker,dest=- client > client.tar
      chdir: docker

  - name: Delete server key to avoid leaks
    file:
      path: docker/client/certs/uscope_0.pem
      state: absent

  - name: push driver images to target
    command: 
    args:
      cmd:  scp driver.tar {{remote_host}}:/home/root
      chdir: docker
  
  - name: push server images to target
    command: 
    args:
      cmd:  scp server.tar {{remote_host}}:/home/root
      chdir: docker

  - name: push database images to target
    command: 
    args:
      cmd:  scp database.tar {{remote_host}}:/home/root
      chdir: docker

  - name: push client images to target
    command: 
    args:
      cmd:  scp client.tar {{remote_host}}:/home/root
      chdir: docker
  
  - name: push docker-compose 
    command: 
    args:
      cmd:  scp docker-compose_zed.yml {{remote_host}}:/home/root/docker-compose.yml
      chdir: docker